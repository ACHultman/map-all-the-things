<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>Map All The Things With Mapbox GL</title>

<!-- Mapbox GL -->
<script src='https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js'></script>
<link href='https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css' rel='stylesheet' />

<style>
html, body {
  font-family: Helvetica, Arial, sans-serif;
  margin: 0;
  padding: 0;
}

html, body, main, #map_container {
  height: 100%;
  width: 100%;
}

#map_container {
  background-color: deeppink;
}
</style>
</head>
<body>

<main>
  <div id="map_container"></div>
</main>

<script>
let basemapStyle = null;
let collisions = null;
let map = null;

const BOUNDS_TORONTO = new mapboxgl.LngLatBounds(
  new mapboxgl.LngLat(-79.639264937, 43.580995995),
  new mapboxgl.LngLat(-79.115243191, 43.855457183),
);
const ZOOM_LEVEL_0 = 10;
const ZOOM_LEVEL_3 = 19;

async function getJson(url) {
  const response = await fetch(url);
  return response.json();
}

/**
 * Converts ESRI map styles to a Mapbox GL-compatible format.
 *
 * @see https://gist.github.com/jgravois/51e2b30e3d6cf6c00f06b263a29108a2
 */
function getStyle(metadata, root) {
  const style = JSON.parse(JSON.stringify(root));
  style.sources.esri = {
    type: 'vector',
    scheme: 'xyz',
    tilejson: metadata.tilejson || '2.0.0',
    format: (metadata.tileInfo && metadata.tileInfo.format) || 'pbf',
    maxzoom: 15,
    tiles: [
      `${style.sources.esri.url}${metadata.tiles[0]}`,
    ],
    description: metadata.description || '',
    name: metadata.name,
  };
  return style;
}

async function initMapbox() {
  const [
    collisionsData,
    metadata,
    root,
  ] = await Promise.all([
    getJson('data/collisions.geojson'),
    getJson('data/metadata.json'),
    getJson('data/root.json'),
  ]);

  basemapStyle = getStyle(metadata, root);
  collisions = collisionsData;
}

function initMap() {
  const $mapContainer = document.getElementById('map_container');

  const options = {
    container: $mapContainer,
    center: BOUNDS_TORONTO.getCenter(),
    dragRotate: false,
    maxBounds: BOUNDS_TORONTO,
    maxZoom: ZOOM_LEVEL_3,
    minZoom: ZOOM_LEVEL_0,
    pitchWithRotate: false,
    renderWorldCopies: false,
    style: basemapStyle,
    zoom: ZOOM_LEVEL_0,
  };

  map = new mapboxgl.Map(options);
  map.on('load', populateMap);
}

function populateMap() {
  // TODO: remove this logging statement
  console.log(collisions);

  // TODO: add a GeoJSON source

  // TODO: add a layer using that source
}

async function main() {
  await initMapbox();
  initMap();
}

main();
</script>
</body>
</html>
